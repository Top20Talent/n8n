pipeline {
    agent {
        node {
            label 'jenkins-slave'
        }
    }

    environment {
        ALIYUN_CREDS = credentials('aliyun-acr')
        GIT_TAG = sh(returnStdout: true,script: 'git rev-parse --short HEAD').trim()
    }
    stages {
        stage('Clone') {
           steps {
               echo "Clone Git Code"
               checkout([$class: 'GitSCM', branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[credentialsId: 'github-credentials', url: 'https://github.com/Top20Talent/n8n.git']]])
           }
        }
        stage('Build Image') {
            when { 
                allOf {
                    expression { env.GIT_TAG != null }
                }
            }
            steps {
                container ('kaniko') {
                    sh """
                    /kaniko/executor --single-snapshot --insecure --context ./ --dockerfile docker/images/n8n-custom/Dockerfile \
                    --destination registry.cn-shanghai.aliyuncs.com/cgp-application/oa-n8n:${GIT_TAG}
                    """
                }
            }
            // steps {
            //     container ('docker') {
            //         sh "docker login -u ${ALIYUN_CREDS_USR} -p ${ALIYUN_CREDS_PSW} registry.cn-shanghai.aliyuncs.com"
            //         sh "ls -l"
            //         sh "echo ${GIT_TAG}"
            //         sh "docker build -t registry.cn-shanghai.aliyuncs.com/cgp-application/oa-n8n:${GIT_TAG} -f docker/images/n8n-custom/Dockerfile ."
            //         sh "docker push registry.cn-shanghai.aliyuncs.com/cgp-application/oa-n8n:${GIT_TAG}"
            //         sh "docker rmi registry.cn-shanghai.aliyuncs.com/cgp-application/oa-n8n:${GIT_TAG}"
            //     }
            // }
        }
        stage('Staging Deployment') {
            when { 
                allOf {
                    expression { env.GIT_TAG != null }
                }
            }
            steps {
                container ('kubectl') {
                    sh "mkdir -p ~/.kube"
                    sh "kubectl get nodes"
                    sh "sed -i 's/GIT_TAG/${GIT_TAG}/g' oa-deploy/charts/n8n/templates/stage/deployment.yaml"
                    sh "kubectl apply -f oa-deploy/charts/n8n/templates/stage/deployment.yaml"
                }
            }
        }
        stage('Confirm production deployment') {
             steps {
                 input message: 'Confirm production deployment?', ok: 'Confirm'
             }
        }
        stage('Production Deployment') {
            when { 
                allOf {
                    expression { env.GIT_TAG != null }
                }
            }
            steps {
                container ('kubectl-ali') {
                    sh "mkdir -p ~/.kube"
                    sh "kubectl get nodes"
                    sh "sed -i 's/GIT_TAG/${GIT_TAG}/g' oa-deploy/charts/n8n/templates/prod/deployment.yaml"
                    sh "kubectl apply -f oa-deploy/charts/n8n/templates/prod/deployment.yaml"
                }
            }
        }
        
    }
    post {
        success { script { notify.success() } }
        failure { script { notify.failure() } }
    }
}
